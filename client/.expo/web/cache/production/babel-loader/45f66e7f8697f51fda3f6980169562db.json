{"ast":null,"code":"import _slicedToArray from\"@babel/runtime/helpers/slicedToArray\";import React,{useState,useEffect,useCallback,useContext}from\"react\";import{connect,useDispatch,useSelector}from\"react-redux\";import View from\"react-native-web/dist/exports/View\";import Text from\"react-native-web/dist/exports/Text\";import ActivityIndicator from\"react-native-web/dist/exports/ActivityIndicator\";import FlatList from\"react-native-web/dist/exports/FlatList\";import TouchableOpacity from\"react-native-web/dist/exports/TouchableOpacity\";import RefreshControl from\"react-native-web/dist/exports/RefreshControl\";import TextInput from\"react-native-web/dist/exports/TextInput\";import{SearchBar,Avatar,ThemeContext,Button,Icon}from\"react-native-elements\";import _ from\"lodash\";import\"moment/locale/fr\";import moment from\"moment\";import{fetchUsers}from\"../../actions/usersActions\";import{fetchConversations,sendMessage,deleteConversation}from\"../../actions/chatActions\";import{apiConfig}from\"../../config\";import{showOverlay}from\"../../actions/overlayAction\";var SearchResultItem=function SearchResultItem(_ref){var _item$avatar;var item=_ref.item,theme=_ref.theme,navigation=_ref.navigation,chat=_ref.chat,dispatch=_ref.dispatch;var _useState=useState(false),_useState2=_slicedToArray(_useState,2),showMessageForm=_useState2[0],setShowMessageForm=_useState2[1];var _useState3=useState(\"\"),_useState4=_slicedToArray(_useState3,2),newMessage=_useState4[0],setNewMessage=_useState4[1];var fullName=_.capitalize(item==null?void 0:item.firstname)+\" \"+_.capitalize(item==null?void 0:item.lastname);return React.createElement(TouchableOpacity,{onPress:chat.interlocutorsIds.includes(item==null?void 0:item._id)?function(){return navigation.navigate(\"Room\",{title:fullName,conversation:chat.convIdsWithPartsIds.filter(function(element){return element.participants.includes(item==null?void 0:item._id)===true;}).filter(function(conv){return conv.participants.length===2;})[0]});}:function(){return dispatch(showOverlay({form:{action:sendMessage,inputName:\"text\",actionParams:{recipients:[item==null?void 0:item._id]},message:\"Demarrer une conversation avec \"+fullName},dispatchCallback:fetchConversations}));}},React.createElement(View,{style:{flexDirection:\"row\",alignItems:\"center\",paddingVertical:4,paddingHorizontal:8,borderBottomColor:theme.colors.grey5,borderBottomWidth:1}},React.createElement(View,{style:{alignContent:\"center\",justifyContent:\"center\",alignItems:\"center\",marginRight:12}},(item==null?void 0:item.avatar)?React.createElement(Avatar,{source:{uri:\"https://siee-gate.herokuapp.com/api/files/avatar/\"+(item==null?void 0:(_item$avatar=item.avatar)==null?void 0:_item$avatar.filename)},size:\"small\"}):React.createElement(Avatar,{size:\"small\",title:item==null?void 0:item.firstname[0].concat(item==null?void 0:item.lastname[0]).toUpperCase()})),!showMessageForm?React.createElement(Text,{style:{paddingLeft:12}},fullName):React.createElement(View,{style:{flexDirection:\"row\",backgroundColor:\"white\",alignItems:\"center\",justifyContent:\"center\",alignContent:\"center\",marginTop:8}},React.createElement(TextInput,{value:newMessage,multiline:true,placeholder:\"Ecrivez ici.\",placeholderTextColor:\"grey\",onChangeText:function onChangeText(text){return setNewMessage(text);},style:{backgroundColor:theme.colors.grey5,borderColor:theme.colors.grey4,borderWidth:1,borderRadius:5,paddingVertical:2,paddingHorizontal:4,maxHeight:80}}),React.createElement(Button,{containerStyle:{height:30},icon:React.createElement(Icon,{name:\"send\",size:20,color:newMessage?theme.colors.primary:theme.colors.grey2}),disabled:!newMessage,type:\"clear\",onPress:function onPress(){onSendMessage(newMessage,item==null?void 0:item._id);setNewMessage(\"\");setShowMessageForm(false);}}))));};var Item=function Item(_ref2){var _item$participants$3,_item$participants$4,_item$participants$4$,_item$participants$5,_item$participants$6,_item$lastMessage,_item$lastMessage2,_item$lastMessage3;var item=_ref2.item,navigation=_ref2.navigation,auth=_ref2.auth,theme=_ref2.theme,dispatch=_ref2.dispatch;var listParticipants=function listParticipants(){var _item$participants;if((item==null?void 0:(_item$participants=item.participants)==null?void 0:_item$participants.length)>1){var _item$participants2;var participantsList=item==null?void 0:(_item$participants2=item.participants)==null?void 0:_item$participants2.map(function(participant){return _.capitalize(participant.firstname);});return participantsList.toString().replace(\",\",\", \");}else{var _item$participants$,_item$participants$2;return _.capitalize(item==null?void 0:(_item$participants$=item.participants[0])==null?void 0:_item$participants$.firstname).concat(\" \",_.capitalize(item==null?void 0:(_item$participants$2=item.participants[0])==null?void 0:_item$participants$2.lastname));}};var participants=listParticipants(item);return React.createElement(TouchableOpacity,{onPress:function onPress(){return navigation.navigate(\"Room\",{conversation:item});}},React.createElement(View,{style:{paddingHorizontal:8,paddingVertical:8,borderBottomColor:\"white\",borderBottomWidth:3,backgroundColor:\"white\"}},React.createElement(View,{style:{flexDirection:\"row\"}},React.createElement(View,{style:{alignContent:\"center\",justifyContent:\"center\",paddingRight:8}},(item==null?void 0:(_item$participants$3=item.participants[0])==null?void 0:_item$participants$3.avatar)?React.createElement(Avatar,{source:{uri:apiConfig.baseUrl+\"/files/avatar/\"+(item==null?void 0:(_item$participants$4=item.participants[0])==null?void 0:(_item$participants$4$=_item$participants$4.avatar)==null?void 0:_item$participants$4$.filename)},size:\"medium\"}):React.createElement(Avatar,{size:\"medium\",title:item==null?void 0:(_item$participants$5=item.participants[0])==null?void 0:_item$participants$5.firstname[0].concat(item==null?void 0:(_item$participants$6=item.participants[0])==null?void 0:_item$participants$6.lastname[0]).toUpperCase()})),React.createElement(View,{style:{flex:1,justifyContent:\"space-between\"}},React.createElement(View,{style:{flexDirection:\"row\",flex:1,justifyContent:\"space-between\"}},React.createElement(Text,{style:{textAlignVertical:\"bottom\",fontSize:16,fontWeight:\"bold\"}},participants),React.createElement(Text,{color:\"grey\",style:{color:\"grey\",fontSize:10,textAlignVertical:\"bottom\"}},_.capitalize(moment(item==null?void 0:(_item$lastMessage=item.lastMessage)==null?void 0:_item$lastMessage.sentAt).locale(\"fr\").fromNow()))),React.createElement(View,{style:{flexDirection:\"row\",alignItems:\"center\"}},React.createElement(View,{style:{alignContent:\"center\",justifyContent:\"center\"}},(item==null?void 0:(_item$lastMessage2=item.lastMessage)==null?void 0:_item$lastMessage2.sender)===auth.user._id?React.createElement(Icon,{name:\"arrow-top-right\",color:theme.colors.grey1,size:14}):React.createElement(Icon,{name:\"arrow-bottom-left\",color:theme.colors.grey3,size:14})),React.createElement(Text,{style:{textAlignVertical:\"center\",fontSize:14,flex:1}},item==null?void 0:(_item$lastMessage3=item.lastMessage)==null?void 0:_item$lastMessage3.text),React.createElement(View,{style:{flexDirection:\"row\",alignContent:\"center\",justifyContent:\"center\"}},React.createElement(Icon,{name:\"dots-horizontal\",style:{alignSelf:\"flex-end\"},onPress:function onPress(){return dispatch(showOverlay({menu:{buttons:[{title:\"Supprimer la conversation\",action:deleteConversation,actionParams:[item==null?void 0:item._id]}]},dispatchCallback:fetchConversations}));}})))))));};var ChatLobbyScreen=function ChatLobbyScreen(_ref3){var navigation=_ref3.navigation;var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),refreshing=_useState6[0],setRefreshing=_useState6[1];var _useState7=useState(\"\"),_useState8=_slicedToArray(_useState7,2),search=_useState8[0],setSearch=_useState8[1];var _useContext=useContext(ThemeContext),theme=_useContext.theme;var dispatch=useDispatch();var _useSelector=useSelector(function(state){return state;}),chat=_useSelector.chat,users=_useSelector.users,auth=_useSelector.auth;useEffect(function(){function fetchData(){dispatch(fetchConversations());dispatch(fetchUsers());}fetchData();},[]);var onRefresh=useCallback(function(){setRefreshing(true);fetchConversations();setRefreshing(false);},[refreshing]);var searchProcess=function searchProcess(){var searchResults=[];users.users.forEach(function(user){if(user._id!==auth.user._id){if(user.firstname.includes(search.toLowerCase())===true||user.lastname.includes(search.toLowerCase())){searchResults.push(user);}}});return searchResults;};return React.createElement(View,{style:{flex:1}},React.createElement(View,{style:{backgroundColor:\"white\",paddingVertical:4}},React.createElement(SearchBar,{placeholder:\"Chercher un alumni ici...\",onChangeText:setSearch,value:search,platform:\"android\",containerStyle:{paddingTop:0,height:40}}),users.isLoaded&&React.createElement(FlatList,{data:search&&searchProcess(),renderItem:function renderItem(_ref4){var item=_ref4.item;return React.createElement(SearchResultItem,{item:item,theme:theme,chat:chat,navigation:navigation,dispatch:dispatch});},keyExtractor:function keyExtractor(item){return item==null?void 0:item._id;}}),!users.isLoaded&&React.createElement(View,{style:{flex:1,alignContent:\"center\",justifyContent:\"center\"}},React.createElement(ActivityIndicator,{size:\"small\"}))),chat.isLoaded?chat.conversations.length>0?React.createElement(FlatList,{data:chat.conversations,renderItem:function renderItem(_ref5){var item=_ref5.item;return React.createElement(Item,{item:item,auth:auth,navigation:navigation,theme:theme,dispatch:dispatch});},keyExtractor:function keyExtractor(item){return item==null?void 0:item._id;},refreshControl:React.createElement(RefreshControl,{refreshing:refreshing,onRefresh:onRefresh})}):React.createElement(View,{style:{flex:1,alignContent:\"center\",justifyContent:\"center\"}},React.createElement(Text,{style:{textAlign:\"center\",color:theme.colors.grey3}},\"Aucune conversation\"),React.createElement(Button,{title:\"Rafraichir\",type:\"clear\",onPress:fetchConversations})):React.createElement(View,{style:{flex:1,alignContent:\"center\",justifyContent:\"center\"}},React.createElement(ActivityIndicator,{size:\"large\"})));};export default ChatLobbyScreen;","map":{"version":3,"sources":["/home/gaetan/Documents/GATE/app/client/src/components/Messages/MessagesLobbyScreen.js"],"names":["React","useState","useEffect","useCallback","useContext","connect","useDispatch","useSelector","SearchBar","Avatar","ThemeContext","Button","Icon","_","moment","fetchUsers","fetchConversations","sendMessage","deleteConversation","apiConfig","showOverlay","SearchResultItem","item","theme","navigation","chat","dispatch","showMessageForm","setShowMessageForm","newMessage","setNewMessage","fullName","capitalize","firstname","lastname","interlocutorsIds","includes","_id","navigate","title","conversation","convIdsWithPartsIds","filter","element","participants","conv","length","form","action","inputName","actionParams","recipients","message","dispatchCallback","flexDirection","alignItems","paddingVertical","paddingHorizontal","borderBottomColor","colors","grey5","borderBottomWidth","alignContent","justifyContent","marginRight","avatar","uri","filename","concat","toUpperCase","paddingLeft","backgroundColor","marginTop","text","borderColor","grey4","borderWidth","borderRadius","maxHeight","height","primary","grey2","onSendMessage","Item","auth","listParticipants","participantsList","map","participant","toString","replace","paddingRight","baseUrl","flex","textAlignVertical","fontSize","fontWeight","color","lastMessage","sentAt","locale","fromNow","sender","user","grey1","grey3","alignSelf","menu","buttons","ChatLobbyScreen","refreshing","setRefreshing","search","setSearch","state","users","fetchData","onRefresh","searchProcess","searchResults","forEach","toLowerCase","push","paddingTop","isLoaded","conversations","textAlign"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useCallback, useContext } from \"react\";\nimport { connect, useDispatch, useSelector } from \"react-redux\";\nimport {\n  View,\n  Text,\n  ActivityIndicator,\n  FlatList,\n  TouchableOpacity,\n  RefreshControl,\n  TextInput,\n} from \"react-native\";\nimport {\n  SearchBar,\n  Avatar,\n  ThemeContext,\n  Button,\n  Icon,\n} from \"react-native-elements\";\nimport _ from \"lodash\";\nimport \"moment/locale/fr\";\nimport moment from \"moment\";\nimport { fetchUsers } from \"../../actions/usersActions\";\nimport {\n  fetchConversations,\n  sendMessage,\n  deleteConversation,\n} from \"../../actions/chatActions\";\nimport { apiConfig } from \"../../config\";\nimport { showOverlay } from \"../../actions/overlayAction\";\n\nconst SearchResultItem = ({ item, theme, navigation, chat, dispatch }) => {\n  const [showMessageForm, setShowMessageForm] = useState(false);\n  const [newMessage, setNewMessage] = useState(\"\");\n  const fullName =\n    _.capitalize(item?.firstname) + \" \" + _.capitalize(item?.lastname);\n\n  return (\n    <TouchableOpacity\n      onPress={\n        chat.interlocutorsIds.includes(item?._id)\n          ? () =>\n              navigation.navigate(\"Room\", {\n                title: fullName,\n                conversation: chat.convIdsWithPartsIds\n                  .filter(\n                    (element) =>\n                      element.participants.includes(item?._id) === true\n                  )\n                  .filter((conv) => conv.participants.length === 2)[0],\n              })\n          : () =>\n              dispatch(\n                showOverlay({\n                  form: {\n                    action: sendMessage,\n                    inputName: \"text\",\n                    actionParams: { recipients: [item?._id] },\n                    message: \"Demarrer une conversation avec \" + fullName,\n                  },\n                  dispatchCallback: fetchConversations,\n                })\n              )\n      }\n    >\n      <View\n        style={{\n          flexDirection: \"row\",\n          alignItems: \"center\",\n          paddingVertical: 4,\n          paddingHorizontal: 8,\n          borderBottomColor: theme.colors.grey5,\n          borderBottomWidth: 1,\n        }}\n      >\n        <View\n          style={{\n            alignContent: \"center\",\n            justifyContent: \"center\",\n            alignItems: \"center\",\n            marginRight: 12,\n          }}\n        >\n          {item?.avatar ? (\n            <Avatar\n              source={{\n                uri: `https://siee-gate.herokuapp.com/api/files/avatar/${item?.avatar?.filename}`,\n              }}\n              size=\"small\"\n            />\n          ) : (\n            <Avatar\n              size=\"small\"\n              title={item?.firstname[0].concat(item?.lastname[0]).toUpperCase()}\n            />\n          )}\n        </View>\n        {!showMessageForm ? (\n          <Text style={{ paddingLeft: 12 }}>{fullName}</Text>\n        ) : (\n          <View\n            style={{\n              flexDirection: \"row\",\n              backgroundColor: \"white\",\n              alignItems: \"center\",\n              justifyContent: \"center\",\n              alignContent: \"center\",\n              marginTop: 8,\n            }}\n          >\n            <TextInput\n              value={newMessage}\n              multiline\n              placeholder=\"Ecrivez ici.\"\n              placeholderTextColor=\"grey\"\n              onChangeText={(text) => setNewMessage(text)}\n              style={{\n                backgroundColor: theme.colors.grey5,\n                borderColor: theme.colors.grey4,\n                borderWidth: 1,\n                borderRadius: 5,\n                paddingVertical: 2,\n                paddingHorizontal: 4,\n                maxHeight: 80,\n              }}\n            />\n            <Button\n              containerStyle={{ height: 30 }}\n              icon={\n                <Icon\n                  name=\"send\"\n                  size={20}\n                  color={newMessage ? theme.colors.primary : theme.colors.grey2}\n                />\n              }\n              disabled={!newMessage}\n              type=\"clear\"\n              onPress={() => {\n                onSendMessage(newMessage, item?._id);\n                setNewMessage(\"\");\n                setShowMessageForm(false);\n              }}\n            />\n          </View>\n        )}\n      </View>\n    </TouchableOpacity>\n  );\n};\n\nconst Item = ({ item, navigation, auth, theme, dispatch }) => {\n  const listParticipants = () => {\n    if (item?.participants?.length > 1) {\n      const participantsList = item?.participants?.map((participant) =>\n        _.capitalize(participant.firstname)\n      );\n      return participantsList.toString().replace(\",\", \", \");\n    } else {\n      return _.capitalize(item?.participants[0]?.firstname).concat(\n        \" \",\n        _.capitalize(item?.participants[0]?.lastname)\n      );\n    }\n  };\n\n  const participants = listParticipants(item);\n\n  return (\n    <TouchableOpacity\n      onPress={() =>\n        navigation.navigate(\"Room\", {\n          conversation: item,\n        })\n      }\n    >\n      <View\n        style={{\n          paddingHorizontal: 8,\n          paddingVertical: 8,\n          borderBottomColor: \"white\",\n          borderBottomWidth: 3,\n          backgroundColor: \"white\",\n        }}\n      >\n        <View style={{ flexDirection: \"row\" }}>\n          <View\n            style={{\n              alignContent: \"center\",\n              justifyContent: \"center\",\n              paddingRight: 8,\n            }}\n          >\n            {item?.participants[0]?.avatar ? (\n              <Avatar\n                source={{\n                  uri: `${apiConfig.baseUrl}/files/avatar/${item?.participants[0]?.avatar?.filename}`,\n                }}\n                size=\"medium\"\n              />\n            ) : (\n              <Avatar\n                size=\"medium\"\n                title={item?.participants[0]?.firstname[0]\n                  .concat(item?.participants[0]?.lastname[0])\n                  .toUpperCase()}\n              />\n            )}\n          </View>\n          <View\n            style={{\n              flex: 1,\n              justifyContent: \"space-between\",\n            }}\n          >\n            <View\n              style={{\n                flexDirection: \"row\",\n                flex: 1,\n                justifyContent: \"space-between\",\n              }}\n            >\n              <Text\n                style={{\n                  textAlignVertical: \"bottom\",\n                  fontSize: 16,\n                  fontWeight: \"bold\",\n                }}\n              >\n                {participants}\n              </Text>\n              <Text\n                color=\"grey\"\n                style={{\n                  color: \"grey\",\n                  fontSize: 10,\n                  textAlignVertical: \"bottom\",\n                }}\n              >\n                {_.capitalize(\n                  moment(item?.lastMessage?.sentAt).locale(\"fr\").fromNow()\n                )}\n              </Text>\n            </View>\n            <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\n              <View\n                style={{ alignContent: \"center\", justifyContent: \"center\" }}\n              >\n                {item?.lastMessage?.sender === auth.user._id ? (\n                  <Icon\n                    name=\"arrow-top-right\"\n                    color={theme.colors.grey1}\n                    size={14}\n                  />\n                ) : (\n                  <Icon\n                    name=\"arrow-bottom-left\"\n                    color={theme.colors.grey3}\n                    size={14}\n                  />\n                )}\n              </View>\n              <Text\n                style={{\n                  textAlignVertical: \"center\",\n                  fontSize: 14,\n                  flex: 1,\n                }}\n              >\n                {item?.lastMessage?.text}\n              </Text>\n              <View\n                style={{\n                  flexDirection: \"row\",\n                  alignContent: \"center\",\n                  justifyContent: \"center\",\n                }}\n              >\n                <Icon\n                  name=\"dots-horizontal\"\n                  style={{ alignSelf: \"flex-end\" }}\n                  onPress={() =>\n                    dispatch(\n                      showOverlay({\n                        menu: {\n                          buttons: [\n                            {\n                              title: \"Supprimer la conversation\",\n                              action: deleteConversation,\n                              actionParams: [item?._id],\n                            },\n                          ],\n                        },\n                        dispatchCallback: fetchConversations,\n                      })\n                    )\n                  }\n                />\n              </View>\n            </View>\n          </View>\n        </View>\n      </View>\n    </TouchableOpacity>\n  );\n};\n\nconst ChatLobbyScreen = ({ navigation }) => {\n  const [refreshing, setRefreshing] = useState(false);\n  const [search, setSearch] = useState(\"\");\n  const { theme } = useContext(ThemeContext);\n  const dispatch = useDispatch();\n  const { chat, users, auth } = useSelector((state) => state);\n\n  useEffect(() => {\n    function fetchData() {\n      dispatch(fetchConversations());\n      dispatch(fetchUsers());\n    }\n    fetchData();\n  }, []);\n\n  const onRefresh = useCallback(() => {\n    setRefreshing(true);\n    fetchConversations();\n    setRefreshing(false);\n  }, [refreshing]);\n\n  const searchProcess = () => {\n    const searchResults = [];\n    users.users.forEach((user) => {\n      if (user._id !== auth.user._id) {\n        if (\n          user.firstname.includes(search.toLowerCase()) === true ||\n          user.lastname.includes(search.toLowerCase())\n        ) {\n          searchResults.push(user);\n        }\n      }\n    });\n    return searchResults;\n  };\n\n  return (\n    <View style={{ flex: 1 }}>\n      <View style={{ backgroundColor: \"white\", paddingVertical: 4 }}>\n        <SearchBar\n          placeholder=\"Chercher un alumni ici...\"\n          onChangeText={setSearch}\n          value={search}\n          platform=\"android\"\n          containerStyle={{\n            paddingTop: 0,\n            height: 40,\n          }}\n        />\n        {users.isLoaded && (\n          <FlatList\n            data={search && searchProcess()}\n            renderItem={({ item }) => (\n              <SearchResultItem\n                item={item}\n                theme={theme}\n                chat={chat}\n                navigation={navigation}\n                dispatch={dispatch}\n              />\n            )}\n            keyExtractor={(item) => item?._id}\n          />\n        )}\n        {!users.isLoaded && (\n          <View\n            style={{\n              flex: 1,\n              alignContent: \"center\",\n              justifyContent: \"center\",\n            }}\n          >\n            <ActivityIndicator size=\"small\" />\n          </View>\n        )}\n      </View>\n      {chat.isLoaded ? (\n        chat.conversations.length > 0 ? (\n          <FlatList\n            data={chat.conversations}\n            renderItem={({ item }) => (\n              <Item\n                item={item}\n                auth={auth}\n                navigation={navigation}\n                theme={theme}\n                dispatch={dispatch}\n              />\n            )}\n            keyExtractor={(item) => item?._id}\n            refreshControl={\n              <RefreshControl refreshing={refreshing} onRefresh={onRefresh} />\n            }\n          />\n        ) : (\n          <View\n            style={{\n              flex: 1,\n              alignContent: \"center\",\n              justifyContent: \"center\",\n            }}\n          >\n            <Text style={{ textAlign: \"center\", color: theme.colors.grey3 }}>\n              Aucune conversation\n            </Text>\n            <Button\n              title=\"Rafraichir\"\n              type=\"clear\"\n              onPress={fetchConversations}\n            />\n          </View>\n        )\n      ) : (\n        <View\n          style={{\n            flex: 1,\n            alignContent: \"center\",\n            justifyContent: \"center\",\n          }}\n        >\n          <ActivityIndicator size=\"large\" />\n        </View>\n      )}\n    </View>\n  );\n};\n\nexport default ChatLobbyScreen;\n"]},"metadata":{},"sourceType":"module"}