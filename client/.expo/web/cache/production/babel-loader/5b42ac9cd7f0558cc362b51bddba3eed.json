{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/defineProperty\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import io from\"socket.io-client\";import axios from\"axios\";import{apiConfig}from\"../config\";import{showOverlay}from\"../actions/overlayAction\";export var devMiddleware=function devMiddleware(store){return function(next){return function(action){console.log(action.type);return next(action);};};};export var socketMiddleware=function socketMiddleware(){var socket;return function(store){return function(next){return function(action){var _action$type;if(!socket&&store.getState().auth.isLoggedIn){console.log(\"socket somehow disconnected\");}if(action.type===\"REQUEST_LOG_IN:SUCCESS\"||action.type===\"REQUEST_SIGN_UP:SUCCESS\"||action.type===\"REQUEST_VERIFY_TOKEN:SUCCESS\"){var token=action.data.token;socket=io(apiConfig.baseUrl,{forceNode:true,transportOptions:{polling:{extraHeaders:{\"Access-Control-Allow-Origin\":\"*\",authorization:token}}}});socket.on(\"connected\",function(data){console.log(\"Socket connected\");});socket.on(\"unauthorized\",function(data){console.log(\"Socket disconnected\");});socket.on(\"authenticated\",function(data){console.log(\"Socket authenticated\");});socket.on(\"private-conversation\",function(data){store.dispatch(_objectSpread({type:\"RECEIVE_PRIVATE_CONVERSATION\"},data,{receivedAt:new Date()}));});socket.on(\"private-conversation-ack\",function(data){store.dispatch(_objectSpread({type:\"PRIVATE_CONVERSATION_ACK\"},data,{receivedAt:new Date()}));});socket.on(\"private-message\",function(data){store.dispatch(_objectSpread({type:\"RECEIVE_PRIVATE_MESSAGE\"},data,{receivedAt:new Date()}));});socket.on(\"private-message-ack\",function(data){store.dispatch(_objectSpread({type:\"PRIVATE_MESSAGE_ACK\"},data,{receivedAt:new Date()}));});}if(((_action$type=action.type)==null?void 0:_action$type.substring(0,6))===\"SOCKET\"){socket.emit(action.event,action.payload);}if(action.type===\"REQUEST_LOG_OUT:SUCCESS\"){socket.disconnect();console.log(\"socket disconnected\");}return next(action);};};};};export var axiosMiddleware=function axiosMiddleware(store){return function(next){return function(action){var _action$type2,_action$type3;if(((_action$type2=action.type)==null?void 0:_action$type2.substring(0,7))===\"REQUEST\"&&((_action$type3=action.type)==null?void 0:_action$type3.includes(\":\"))===false){var https;if(action.type.substring(0,14)===\"REQUEST_UPLOAD\"){https=axios.create({baseURL:apiConfig.baseUrl+\"/api/\",timeout:3000,headers:{accept:\"application/json\",\"Access-Control-Allow-Origin\":\"*\",\"Content-Type\":\"multipart/form-data\",Authorization:\"Bearer \"+store.getState().auth.token}});}else{https=axios.create({baseURL:apiConfig.baseUrl+\"/api/\",timeout:3000,headers:{\"Access-Control-Allow-Origin\":\"*\",\"Content-Type\":\"application/json\",Authorization:\"Bearer \"+store.getState().auth.token}});}var request=new Promise(function(resolve,reject){var res;switch(action.method){case\"GET\":res=https.get(action.route);return resolve(res);case\"POST\":res=https.post(action.route,action.payload);return resolve(res);case\"DELETE\":res=https.delete(action.route,action.payload);return resolve(res);case\"PATCH\":res=https.patch(action.route,action.payload);return resolve(res);default:return;}});request.then(function(res){if(action.successNotification){store.dispatch(showOverlay({timeout:3000,redirect:action.successNotification.redirect,callbacks:action.successNotification.callbacks,notification:{variant:\"success\",message:action.successNotification.message}}));}return store.dispatch({type:action.type+\":SUCCESS\",data:res.data,receivedAt:new Date()});}).catch(function(err){var _err$response;console.log(err);if(action.errorNotification||((_err$response=err.response)==null?void 0:_err$response.data.forceReconnect)===true){var _err$response2,_err$response3,_err$response4;store.dispatch(showOverlay({timeout:3000,redirect:((_err$response2=err.response)==null?void 0:_err$response2.data.forceReconnect)&&\"Auth\",callbacks:((_err$response3=err.response)==null?void 0:_err$response3.data.forceReconnect)&&[\"REQUEST_LOG_OUT:SUCCESS\"],notification:{variant:\"error\",message:((_err$response4=err.response)==null?void 0:_err$response4.data.message)||\"Cela n'a pas marché...\"}}));}return store.dispatch({type:action.type+\":ERROR\",error:err,receivedAt:new Date()});});return next(action);}else{return next(action);}};};};","map":{"version":3,"sources":["/home/gaetan/Documents/GATE/app/client/src/store/reduxMiddlewares.js"],"names":["io","axios","apiConfig","showOverlay","devMiddleware","store","next","action","console","log","type","socketMiddleware","socket","getState","auth","isLoggedIn","token","data","baseUrl","forceNode","transportOptions","polling","extraHeaders","authorization","on","dispatch","receivedAt","Date","substring","emit","event","payload","disconnect","axiosMiddleware","includes","https","create","baseURL","timeout","headers","accept","Authorization","request","Promise","resolve","reject","res","method","get","route","post","delete","patch","then","successNotification","redirect","callbacks","notification","variant","message","catch","err","errorNotification","response","forceReconnect","error"],"mappings":"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","sourcesContent":["import io from \"socket.io-client\";\nimport axios from \"axios\";\nimport { apiConfig } from \"../config\";\nimport { showOverlay } from \"../actions/overlayAction\";\n\nexport const devMiddleware = (store) => (next) => (action) => {\n  console.log(action.type);\n  return next(action);\n};\n\nexport const socketMiddleware = () => {\n  let socket;\n  return (store) => (next) => (action) => {\n    if (!socket && store.getState().auth.isLoggedIn) {\n      console.log(\"socket somehow disconnected\");\n    }\n    if (\n      action.type === \"REQUEST_LOG_IN:SUCCESS\" ||\n      action.type === \"REQUEST_SIGN_UP:SUCCESS\" ||\n      action.type === \"REQUEST_VERIFY_TOKEN:SUCCESS\"\n    ) {\n      const { token } = action.data;\n      socket = io(apiConfig.baseUrl, {\n        forceNode: true,\n        transportOptions: {\n          polling: {\n            extraHeaders: {\n              \"Access-Control-Allow-Origin\": \"*\",\n              authorization: token,\n            },\n          },\n        },\n      });\n      socket.on(\"connected\", (data) => {\n        console.log(\"Socket connected\");\n      });\n      socket.on(\"unauthorized\", (data) => {\n        console.log(\"Socket disconnected\");\n      });\n      socket.on(\"authenticated\", (data) => {\n        console.log(\"Socket authenticated\");\n      });\n      socket.on(\"private-conversation\", (data) => {\n        store.dispatch({\n          type: \"RECEIVE_PRIVATE_CONVERSATION\",\n          ...data,\n          receivedAt: new Date(),\n        });\n      });\n      socket.on(\"private-conversation-ack\", (data) => {\n        store.dispatch({\n          type: \"PRIVATE_CONVERSATION_ACK\",\n          ...data,\n          receivedAt: new Date(),\n        });\n      });\n      socket.on(\"private-message\", (data) => {\n        store.dispatch({\n          type: \"RECEIVE_PRIVATE_MESSAGE\",\n          ...data,\n          receivedAt: new Date(),\n        });\n      });\n      socket.on(\"private-message-ack\", (data) => {\n        store.dispatch({\n          type: \"PRIVATE_MESSAGE_ACK\",\n          ...data,\n          receivedAt: new Date(),\n        });\n      });\n    }\n    if (action.type?.substring(0, 6) === \"SOCKET\") {\n      socket.emit(action.event, action.payload);\n    }\n    if (action.type === \"REQUEST_LOG_OUT:SUCCESS\") {\n      socket.disconnect();\n      console.log(\"socket disconnected\");\n    }\n\n    return next(action);\n  };\n};\n\nexport const axiosMiddleware = (store) => (next) => (action) => {\n  if (\n    action.type?.substring(0, 7) === \"REQUEST\" &&\n    action.type?.includes(\":\") === false\n  ) {\n    let https;\n    if (action.type.substring(0, 14) === \"REQUEST_UPLOAD\") {\n      https = axios.create({\n        baseURL: apiConfig.baseUrl + \"/api/\",\n        timeout: 3000,\n        headers: {\n          accept: \"application/json\",\n          \"Access-Control-Allow-Origin\": \"*\",\n          \"Content-Type\": \"multipart/form-data\",\n          Authorization: `Bearer ${store.getState().auth.token}`,\n        },\n      });\n    } else {\n      https = axios.create({\n        baseURL: apiConfig.baseUrl + \"/api/\",\n        timeout: 3000,\n        headers: {\n          \"Access-Control-Allow-Origin\": \"*\",\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${store.getState().auth.token}`,\n        },\n      });\n    }\n    const request = new Promise(function (resolve, reject) {\n      let res;\n\n      switch (action.method) {\n        case \"GET\":\n          res = https.get(action.route);\n          return resolve(res);\n        case \"POST\":\n          res = https.post(action.route, action.payload);\n          return resolve(res);\n        case \"DELETE\":\n          res = https.delete(action.route, action.payload);\n          return resolve(res);\n        case \"PATCH\":\n          res = https.patch(action.route, action.payload);\n          return resolve(res);\n        default:\n          return;\n      }\n    });\n    request\n      .then((res) => {\n        if (action.successNotification) {\n          store.dispatch(\n            showOverlay({\n              timeout: 3000,\n              redirect: action.successNotification.redirect,\n              callbacks: action.successNotification.callbacks,\n              notification: {\n                variant: \"success\",\n                message: action.successNotification.message,\n              },\n            })\n          );\n        }\n        return store.dispatch({\n          type: `${action.type}:SUCCESS`,\n          data: res.data,\n          receivedAt: new Date(),\n        });\n      })\n      .catch((err) => {\n        console.log(err);\n        if (\n          action.errorNotification ||\n          err.response?.data.forceReconnect === true\n        ) {\n          store.dispatch(\n            showOverlay({\n              timeout: 3000,\n              redirect: err.response?.data.forceReconnect && \"Auth\",\n              callbacks: err.response?.data.forceReconnect && [\n                \"REQUEST_LOG_OUT:SUCCESS\",\n              ],\n              notification: {\n                variant: \"error\",\n                message: err.response?.data.message || \"Cela n'a pas marché...\",\n              },\n            })\n          );\n        }\n        return store.dispatch({\n          type: `${action.type}:ERROR`,\n          error: err,\n          receivedAt: new Date(),\n        });\n      });\n\n    return next(action);\n  } else {\n    return next(action);\n  }\n};\n"]},"metadata":{},"sourceType":"module"}